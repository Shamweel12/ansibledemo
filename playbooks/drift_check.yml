- name: Detect unauthorized VLAN creation (simple demo)
  hosts: all
  gather_facts: no
  connection: network_cli

  tasks:

    - name: Load approved VLANs from Git
      set_fact:
        approved_vlans: "{{ lookup('file', playbook_dir ~ '/../golden/' ~ inventory_hostname ~ '.yml')
                            | from_yaml
                            | dict2items
                            | map(attribute='value')
                            | first }}"

    - name: Get VLAN table
      cisco.ios.ios_command:
        commands:
          - show vlan brief
      register: vlan_output

    - name: Check if VLAN 2001 exists
      set_fact:
        vlan_2001_present: "{{ '2001' in vlan_output.stdout[0] }}"

    - name: Fail job if unauthorized VLAN detected
      fail:
        msg: |
          ðŸš¨ CONFIGURATION DRIFT DETECTED ðŸš¨

          Device: {{ inventory_hostname }}
          Unauthorized VLAN: 2001

          VLAN 2001 was created manually and is NOT approved.
      when:
        - vlan_2001_present
        - "'2001' not in approved_vlans"

