- name: Detect unauthorized VLAN creation
  hosts: all
  gather_facts: no
  connection: network_cli

  tasks:

    # ---------------------------------------
    # Load approved VLANs from Git
    # ---------------------------------------
    - name: Load approved VLANs
      set_fact:
        approved_vlans: >-
          {{ lookup('file', playbook_dir ~ '/../golden/' ~ inventory_hostname ~ '.yml')
             | from_yaml
             | dict2items
             | selectattr('key','equalto','approved_vlans')
             | map(attribute='value')
             | first }}

    # ---------------------------------------
    # Get VLAN list from device
    # ---------------------------------------
    - name: Get VLAN table
      cisco.ios.ios_command:
        commands:
          - show vlan brief
      register: vlan_output

    # ---------------------------------------
    # Extract VLAN IDs from output
    # ---------------------------------------
    - name: Extract VLAN IDs
      set_fact:
        device_vlans: >-
          {{ vlan_output.stdout[0].splitlines()
             | select('match','^\\s*\\d+')
             | map('regex_search','^\\s*(\\d+)','\\1')
             | list }}

    # ---------------------------------------
    # Find unauthorized VLANs
    # ---------------------------------------
    - name: Find unauthorized VLANs
      set_fact:
        unauthorized_vlans: "{{ device_vlans | difference(approved_vlans) }}"

    # ---------------------------------------
    # Build drift message
    # ---------------------------------------
    - name: Build drift message
      set_fact:
        drift_message: >-
          UNAUTHORIZED VLAN(S) DETECTED:
          {{ unauthorized_vlans | join(', ') }}

    # ---------------------------------------
    # Publish drift message for notifications
    # ---------------------------------------
    - name: Publish drift artifact
      set_stats:
        data:
          drift_message: "{{ drift_message }}"
          unauthorized_vlans: "{{ unauthorized_vlans }}"

    # ---------------------------------------
    # Fail job if drift exists
    # ---------------------------------------
    - name: Fail if unauthorized VLAN detected
      fail:
        msg: "{{ drift_message }}"
      when: unauthorized_vlans | length > 0

