- name: Detect unauthorized interface VLAN change (robust parser + notification)
  hosts: all
  gather_facts: no
  connection: network_cli

  tasks:

    # --------------------------------------------------
    # Load golden intent from Git
    # --------------------------------------------------
    - name: Load interface intent from golden file
      set_fact:
        golden: "{{ lookup('file', playbook_dir ~ '/../golden/' ~ inventory_hostname ~ '.yml') | from_yaml }}"

    - name: Normalize interface name to short form
      set_fact:
        iface_short: "{{ golden.interface_intent.name | regex_replace('GigabitEthernet', 'Gi') }}"

    # --------------------------------------------------
    # Get VLAN table from device
    # --------------------------------------------------
    - name: Get VLAN table from device
      cisco.ios.ios_command:
        commands:
          - show vlan brief
      register: vlan_output

    # --------------------------------------------------
    # Initialize parser variables
    # --------------------------------------------------
    - name: Initialize parser variables
      set_fact:
        detected_vlan: "NONE"
        current_vlan: "NONE"

    # --------------------------------------------------
    # Track current VLAN while parsing table
    # --------------------------------------------------
    - name: Track current VLAN while parsing table
      set_fact:
        current_vlan: >-
          {{ (item | regex_findall('^\\s*(\\d+)\\s+'))[0]
             if (item is match('^\\s*\\d+')) else current_vlan }}
      loop: "{{ vlan_output.stdout[0].splitlines() }}"

    # --------------------------------------------------
    # Detect VLAN where interface appears
    # --------------------------------------------------
    - name: Detect VLAN where interface appears
      set_fact:
        detected_vlan: "{{ (item | regex_findall('^\\s*(\\d+)\\s+'))[0] }}"
      when:
        - iface_short in item
        - detected_vlan == "NONE"
        - item is match('^\\s*\\d+')
      loop: "{{ vlan_output.stdout[0].splitlines() }}"

    # --------------------------------------------------
    # Show comparison in job output
    # --------------------------------------------------
    - name: Show comparison (job output)
      debug:
        msg:
          - "Approved VLAN (Git): {{ golden.interface_intent.access_vlan }}"
          - "Detected VLAN on interface: {{ detected_vlan }}"

    # --------------------------------------------------
    # Publish drift details as job artifacts (CRITICAL)
    # --------------------------------------------------
    - name: Publish drift details for notification
      set_stats:
        data:
          drift_message: >-
            UNAUTHORIZED CHANGE DETECTED:
            Interface {{ golden.interface_intent.name }}
            expected VLAN {{ golden.interface_intent.access_vlan }}
            but found VLAN {{ detected_vlan }}
          expected_vlan: "{{ golden.interface_intent.access_vlan }}"
          actual_vlan: "{{ detected_vlan }}"

    # --------------------------------------------------
    # Fail job if drift is detected
    # --------------------------------------------------
    - name: Fail if VLAN drift detected
      fail:
        msg: "{{ drift_message }}"
      when: detected_vlan|string != golden.interface_intent.access_vlan|string

